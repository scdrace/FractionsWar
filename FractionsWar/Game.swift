//
//  swift
//  FractionsWar
//
//  Created by David Race on 3/25/16.
//
//

import Foundation
import UIKit

class Game: Codable, CustomStringConvertible {
    
    var data = [[String:String]]()
    var warDeck = false
    var warMode = false
    var shouldShowWarCards = false
    var roundStartTime = 0.0
    var swipeTime = 0.0
    var playerMode = 0
    let player1: Player
    let player2: Player
    var customDeck = false
    
    let fileTimeStamp: String
    let deckRandomizer = DeckRandomizer()
    let appBeginTime = CACurrentMediaTime()
    
    var loadGame = false
//    fileprivate var _player1: Player
//    var player1: Player { return _player1 }
//
//    fileprivate var _player2: Player
//    var player2: Player { return _player2 }
    
    fileprivate var _round = 0
    var round: Int {
        get { return _round }
        set { _round = (newValue) }
    }
    
    fileprivate var _gameState = GameState.start
    var gameState: GameState {
        get {
            return _gameState
        }
        set {
            _gameState = (newValue)
        }
    }
    
    var description: String {
        return "x"
    }
    
    let gameStartTime: Double
    var _cumulativeTime: Double = 0.0
    var cumulativeTime: Double {
        get { return _cumulativeTime }
        set { _cumulativeTime = newValue }
    }
    
    
    init(player1Name: String, player2Name: String) {
        
        player1 = Player(name: player1Name)
        player2 = Player(name: player2Name)

        
        func timeStamp() -> String {
            let dateFormatter = DateFormatter()
            dateFormatter.dateFormat = "yyyy'_'MM'_'dd'__'HH'_'mm'_'a"
            
            let date = dateFormatter.string(from: Date())
            return date
        }
        
        gameStartTime = CACurrentMediaTime()
        
        //self.data.game = self
        _round = 1

        /*
        do {
            player1.id = try String(contentsOfURL: player1IDURL(), encoding: NSUTF8StringEncoding)
            print(player1.id)
        }
        catch {
            
        }
        */
        
        fileTimeStamp = timeStamp()
        
        deckRandomizer.dealCards(player1: player1, player2: player2)
        //player1.deck = deckRandomizer.p1WarDeck
        //player2.deck = deckRandomizer.p2WarDeck
        
    }
    
//    convenience init(customDeck: [[String]]) {
//        self.init()
//        
//        
//        //let deckCustom = deck.makeDeckCustom(data: customDeck)
//        
//        //makeCustomDecks(playerDecks: deckCustom)
//        
//    }
    
    func dealCards() {
        // If game is loaded from memory and hands have been dealt
        // ...leave hands alone
        guard gameState != .cardsDealt else { return }
        
        print("Before deal:", player1.deck.count, player2.deck.count)
        if warMode == true {
            player1.makeHands(totalHands: 2)
            player2.makeHands(totalHands: 2)
        } else {
            player1.makeHands()
            player2.makeHands()
        }

        print("After  deal:", player1.deck.count, player2.deck.count)

        if highHand == "tie" {
            warMode = true
        } else {
            warMode = false
        }
        
        // Update State
        gameState = .cardsDealt
        
    }
}

// Methods for saving data
extension Game {
    @objc func saveChanges() -> Bool {
        //print("Saving items to: \(gameArchiveURL.path)")
        
        let fName = player1.name + "_" + player2.name
        do {
            let jsonURL = FileManager.documentDirectoryURL.appendingPathComponent(fName).appendingPathExtension("json")
            let jsonEncoder = JSONEncoder()
            let jsonData = try jsonEncoder.encode(self)
            try jsonData.write(to:jsonURL)
            print("SAVED FILE", jsonURL)
            return true
        } catch {
            
        }
        
        return false
    }
    
    //MARK: - Save Data
    func saveDataImmediate(_ swipeTime: Double) {
        //data.saveRoundData(round, swipeTime: swipeTime, highHand: highHand)
        //print("XXXXXXX:\(info)")
        //data.saveToTextImmediately(info)
        
    }
}

extension Game {
    
    var highHand: String {
        if player1.hand!.decimalValue - player2.hand!.decimalValue > 0 {
            return "player1"
        }
        else if player1.hand!.decimalValue - player2.hand!.decimalValue < 0 {
            return "player2"
        }
        else {
            return "tie"
        }
    }
    
    
    func roundWinner() -> Player? {
        if player1.hand!.decimalValue > player2.hand!.decimalValue {
            return player1
        } else if player2.hand!.decimalValue < player2.hand!.decimalValue {
            return player2                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         }
        return nil
    }
    
    func addHandsToWinnerDeck(winner: Player) {
        let shuffledCards: [Card] = (player1.flatHands() + player2.flatHands()).shuffle()
        winner.addCardsToDeck(cards: shuffledCards)
    }
    
    func removeHands() {
        player1.removeHands()
        player2.removeHands()
    }
}

extension Int {
    func random() -> Int {
        return Int(arc4random_uniform(UInt32(self)))
    }
}

extension Array {
    
    func shuffle() -> Array {
        
        var result = self
        
        for (index, _) in result.enumerated() {
            let a = index
            let b = result.count.random()
            result.swapAt(a, b)
            
        }
        return result
    }
}
